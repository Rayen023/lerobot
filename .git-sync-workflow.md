# Git Sync Workflow Between Two Machines

## Overview
This setup allows you to:
- Keep `pyproject.toml` machine-specific on both servers
- Sync all source code (`src/`), documentation, and shared files
- Merge upstream changes without conflicts in machine-specific configs

## Machine Roles
- **Training Server** (this machine): `/home/rayen/scratch/lerobot`
- **Inference Server**: Your other machine

## Setup (Already Done)

### 1. Git Attributes Configuration
The `.gitattributes` file specifies merge strategy for machine-specific config:
```
pyproject.toml merge=ours          # Keep local version
```

### 2. Git Configuration
Configure the merge driver (run once per machine):
```bash
git config merge.ours.driver true
```

## Daily Workflow

### On Training Server (this machine)

#### Pulling Latest Changes from Upstream & Remote
```bash
# 1. Commit your local changes first
git add .
git commit -m "Training server updates"

# 2. Pull from origin (your fork's main)
git pull origin main

# Note: pyproject.toml will keep local version due to merge strategy

# 3. If you want upstream changes
git fetch upstream
git merge upstream/main
```

#### Pushing Your Changes
```bash
# Commit and push everything (except pyproject.toml conflicts)
git add .
git commit -m "Updates"
git push origin main
```

### On Inference Server

#### Pulling Latest Changes
```bash
# 1. Commit your local changes
git add .
git commit -m "Inference server updates"

# 2. Pull from origin
git pull origin main

# Note: Your local pyproject.toml stays intact
```

#### Pushing Your Changes
```bash
# Commit and push everything
git add .
git commit -m "Updates"
git push origin main
```

## Managing pyproject.toml Changes

### If Upstream Changes pyproject.toml
You need to manually merge important changes:

```bash
# 1. Check what changed in upstream
git fetch upstream
git diff HEAD..upstream/main -- pyproject.toml > /tmp/pyproject-changes.diff

# 2. Review the diff
cat /tmp/pyproject-changes.diff

# 3. Manually apply relevant changes to your local pyproject.toml
# Keep machine-specific dependencies like:
# - flash-attn configurations
# - local paths
# - CUDA-specific settings
```

### Syncing pyproject.toml Between Your Two Machines

Since both machines need different configs, track them separately:

```bash
# On training server - commit your training-specific pyproject.toml
cp pyproject.toml pyproject.training.toml
git add pyproject.training.toml
git commit -m "Training server pyproject config"
git push origin main

# On inference server - commit your inference-specific pyproject.toml
cp pyproject.toml pyproject.inference.toml  
git add pyproject.inference.toml
git commit -m "Inference server pyproject config"
git push origin main
```

Then each machine can reference the appropriate version when needed.

## Best Practices

### Files That Sync Automatically
- Everything except what's in `.gitignore` and `pyproject.toml`
- Just use `git add .` and commit normally

### Files That Stay Machine-Specific
- `pyproject.toml` - Automatically kept local during merges
- Files in `.gitignore`:
  - `datasets/` - Large dataset files
  - `outputs/` - Training outputs
  - `wandb/` - Weights & Biases logs
  - `.cache/` - Cached files

### Already in .gitignore
Check your `.gitignore` includes:
```
outputs/
wandb/
.cache/
datasets/
*.pyc
__pycache__/
```

## Handling Conflicts

### If You Get Merge Conflicts
```bash
# 1. Check which files have conflicts
git status

# 2. For pyproject.toml - keep yours (should auto-resolve with merge=ours)
git checkout --ours pyproject.toml

# 3. For other files - manually resolve
# Edit the file and remove conflict markers
# Then:
git add <resolved-file>

# 4. Complete the merge
git commit
```

## Emergency Recovery

### If Merge Goes Wrong
```bash
# Abort the merge
git merge --abort

# Or reset to before merge
git reset --hard HEAD@{1}
```

### If You Accidentally Committed Machine-Specific Files
```bash
# Remove from staging but keep local file
git reset HEAD pyproject.toml

# Or remove from last commit
git reset --soft HEAD~1
```

## Upstream Sync Schedule

### Weekly or Bi-weekly
```bash
# Fetch upstream changes
git fetch upstream

# Check what's new
git log HEAD..upstream/main --oneline

# Merge if desired
git merge upstream/main

# Resolve any conflicts (mainly in shared code)
# Push to your fork
git push origin main
```

## Quick Reference Commands

```bash
# Status check
git status
git log --oneline -10

# Commit everything
git add .
git commit -m "Updates"
git push origin main

# Pull updates (pyproject.toml stays local)
git pull origin main

# Fetch and merge upstream
git fetch upstream
git merge upstream/main

# Emergency abort
git merge --abort
git reset --hard HEAD
```

## Current State on This Machine

- Branch: `main`
- Behind origin/main by: 10 commits
- Local changes in:
  - `README.md` (shared - should sync)
  - `pyproject.toml` (machine-specific - keep local)
  - Training scripts (machine-specific - keep local)
  - New files: `read_episodes.py`, `TRAINING_NOTES.md`, `train.sh`

## Next Steps for Current Sync
See: `.git-sync-immediate-steps.md`
